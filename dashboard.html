<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>797 Distillery Ferm Dashboard</title>

  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    body {
      background:#111;
      color:white;
      font-family:Arial, sans-serif;
      padding:20px;
    }
    .card {
      background:#1a1a1a;
      padding:20px;
      border-radius:12px;
      margin-bottom:20px;
    }
    #gravity_chart { width:100%; height:350px; }
    .value-block { margin-right:20px; }
    .value { font-size:1.5rem; }
  </style>
</head>

<body>

<h1>797 Distillery â€¢ Fermentation Dashboard</h1>
<p>Black & Green Tilt Live Readings</p>

<div class="card">
  <h2>Gravity Chart</h2>
  <p>Range: <span id="rangeLabel">Today</span></p>
  <select id="rangeSelect">
    <option value="1">Today</option>
    <option value="3">Last 3 days</option>
    <option value="5">Last 5 days</option>
    <option value="7">Last 7 days</option>
  </select>

  <div id="gravity_chart"></div>
</div>

<div class="card">
  <h2>Black Tilt</h2>
  <div class="value-block">
    <div>Gravity: <span id="blackGravity">--</span></div>
    <div>Temp: <span id="blackTemp">--</span></div>
    <div>ABV: <span id="blackABV">--</span></div>
    <div id="blackUpdated">Last update: --</div>
  </div>
</div>

<div class="card">
  <h2>Green Tilt</h2>
  <div class="value-block">
    <div>Gravity: <span id="greenGravity">--</span></div>
    <div>Temp: <span id="greenTemp">--</span></div>
    <div>ABV: <span id="greenABV">--</span></div>
    <div id="greenUpdated">Last update: --</div>
  </div>
</div>

<script>
google.charts.load("current", {packages:["corechart"]});
google.charts.setOnLoadCallback(initDashboard);

const SHEET_ID = "1cV8POWA9l0hlAyZPB1RYLYaqa4T4pXIRzQ3e6C9qkE8";
const OG = 1.086;
const DATASETS = [
  { sheet:"Black Corn", key:"black" },
  { sheet:"Green Corn", key:"green" }
];

function initDashboard() {
  document.getElementById("rangeSelect").addEventListener("change", () => {
    updateRangeLabel(); updateDashboard();
  });
  updateRangeLabel();
  updateDashboard();
  setInterval(updateDashboard, 20000);
}

function getRangeDays() {
  return parseInt(document.getElementById("rangeSelect").value || "1", 10);
}

function updateRangeLabel() {
  const d = getRangeDays();
  document.getElementById("rangeLabel").textContent = d === 1 ? "Today" : `Last ${d} days`;
}

function updateDashboard() {
  Promise.all(DATASETS.map(ds => loadSheet(ds.sheet))).then(res => {
    let dataObj = {};
    DATASETS.forEach((ds,i) => dataObj[ds.sheet] = res[i]);
    updateTiles(dataObj);
    drawChart(dataObj);
  });
}

function loadSheet(sheet) {
  const q = "select A,B,C where A is not null order by A";
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}&tq=${encodeURIComponent(q)}`;
  return fetch(url).then(r=>r.text()).then(t=>JSON.parse(t.substr(47).slice(0,-2)).table);
}

function toDate(raw) {
  if (!raw) return new Date();
  if (typeof raw==="object" && "v" in raw) raw = raw.v;
  if (typeof raw==="string" && raw.includes("Date(")) {
    const p = raw.replace("Date(","").replace(")","").split(",").map(Number);
    return new Date(p[0], p[1], p[2], p[3], p[4], p[5]);
  }
  const d = new Date(raw);
  return isNaN(d.getTime()) ? new Date() : d;
}

function parseTS(raw) {
  const d = toDate(raw);
  return d.toLocaleString("en-US",{hour:"2-digit",minute:"2-digit",month:"short",day:"2-digit"});
}

function calcABV(sg) {
  return (OG - sg) * 131.25;
}

function updateTiles(data) {
  updateOne(data["Black Corn"], "black");
  updateOne(data["Green Corn"], "green");
}

function updateOne(table, key) {
  if (!table || !table.rows.length) return;

  const last = table.rows[table.rows.length - 1].c;
  const ts = last[0].v;
  const temp = Number(last[1].v);
  const sg = Number(last[2].v);

  document.getElementById(`${key}Temp`).textContent = temp.toFixed(1);
  document.getElementById(`${key}Gravity`).textContent = sg.toFixed(3);
  document.getElementById(`${key}ABV`).textContent = calcABV(sg).toFixed(2);
  document.getElementById(`${key}Updated`).textContent = "Last update: " + parseTS(ts);
}

function extractSeries(table) {
  const out = [];
  table.rows.forEach(r=>{
    const c = r.c;
    if (c && c[0] && c[2]) out.push({time: toDate(c[0].v), sg: Number(c[2].v)});
  });
  return out;
}

function drawChart(all) {
  const black = extractSeries(all["Black Corn"]);
  const green = extractSeries(all["Green Corn"]);
  const cutoff = new Date().getTime() - getRangeDays()*86400000;

  const merged = [];
  black.forEach(p=>{ if(p.time.getTime()>cutoff) merged.push([p.time,p.sg,null]); });
  green.forEach(p=>{ if(p.time.getTime()>cutoff) merged.push([p.time,null,p.sg]); });
  merged.sort((a,b)=>a[0]-b[0]);

  const data = new google.visualization.DataTable();
  data.addColumn("datetime","Time");
  data.addColumn("number","Black");
  data.addColumn("number","Green");
  merged.forEach(r=>data.addRow(r));

  new google.visualization.LineChart(document.getElementById("gravity_chart"))
    .draw(data,{backgroundColor:"transparent"});
}
</script>

</body>
</html>
