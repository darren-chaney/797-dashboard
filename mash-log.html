<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>797 Distillery ‚Äî Mash Log</title>

  <!-- Shared header -->
  <link rel="stylesheet" href="header.css?v=1.0.0" />
  <!-- Mash app css -->
  <link rel="stylesheet" href="mash.css?v=1.0.1" />
</head>

<body>

  <!-- GLOBAL HEADER -->
  <div id="global-header"></div>

  <script>
    const PAGE_TITLE = "Mash Log";
    const PAGE_SUBTITLE =
      "Live mash lifecycle journal (pH, SG, temperature, notes).";

    fetch("header.html?v=1.0.0")
      .then(r => r.text())
      .then(html => {
        document.getElementById("global-header").innerHTML = html;
      })
      .catch(()=>{});
  </script>

  <main class="mash-container">

    <!-- LOG SELECTOR -->
    <div class="panel mash-panel">
      <h3>Select Mash Log</h3>
      <select id="logSelect">
        <option value="">Loading mash logs‚Ä¶</option>
      </select>
    </div>

    <!-- LOG CONTENT -->
    <div id="logSection" style="display:none;">

      <!-- META -->
      <div class="panel mash-panel">
        <h2>Mash Log</h2>
        <div id="logMeta" class="muted"></div>
      </div>

      <!-- ADD ENTRY -->
      <div class="panel mash-panel">
        <h3>Add Entry</h3>

        <div class="mash-grid">
          <div>
            <label>pH</label>
            <input id="inPH" type="number" step="0.01" />
          </div>
          <div>
            <label>SG</label>
            <input id="inSG" type="number" step="0.001" />
          </div>
          <div>
            <label>Temp (¬∞F)</label>
            <input id="inTemp" type="number" step="0.1" />
          </div>
          <div>
            <label>Notes</label>
            <input id="inNotes" type="text" />
          </div>
        </div>

        <!-- YEAST / NUTRIENT -->
        <div style="margin-top:14px;">
          <label>Yeast / Nutrient Added</label>
          <select id="addYN">
            <option value="">None</option>
            <option value="yeast">Yeast</option>
            <option value="nutrient">Nutrient</option>
          </select>
        </div>

        <div id="ynFields" class="mash-grid" style="display:none;">
          <div>
            <label>Product</label>
            <input id="ynProduct" type="text" />
          </div>
          <div>
            <label>Amount</label>
            <input id="ynAmount" type="number" step="0.1" />
          </div>
          <div>
            <label>Unit</label>
            <select id="ynUnit">
              <option value="g">g</option>
              <option value="oz">oz</option>
            </select>
          </div>
        </div>

        <!-- PH ADJUST -->
        <div style="margin-top:14px;">
          <label>pH Adjustment</label>
          <select id="phAction">
            <option value="">None</option>
            <option value="lower">Lower pH</option>
            <option value="raise">Raise pH</option>
          </select>
        </div>

        <div id="phFields" class="mash-grid" style="display:none;">
          <div>
            <label>Product</label>
            <input id="phProduct" type="text" />
          </div>
          <div>
            <label>Amount</label>
            <input id="phAmount" type="number" step="0.1" />
          </div>
          <div>
            <label>Unit</label>
            <select id="phUnit">
              <option value="g">g</option>
              <option value="ml">mL</option>
            </select>
          </div>
        </div>

        <div style="margin-top:14px;">
          <button id="btnAddEntry">Add Entry</button>
        </div>
      </div>

      <!-- ENTRIES -->
      <div class="panel mash-panel">
        <h3>Log Entries</h3>
        <div id="entries"></div>
      </div>

    </div>

    <div class="muted" style="margin-top:16px;text-align:right;">
      Mash Log (Cloud-Synced)
    </div>

  </main>

  <script src="mash-log.js"></script>

  <script>
    const el = id => document.getElementById(id);
    let currentLogId = null;
    let cachedEntries = [];

    /* =========================
       Dropdown behavior
       ========================= */
    el("addYN").onchange = () =>
      el("ynFields").style.display = el("addYN").value ? "grid" : "none";

    el("phAction").onchange = () =>
      el("phFields").style.display = el("phAction").value ? "grid" : "none";

    function resetEntryForm(){
      ["inPH","inSG","inTemp","inNotes","ynProduct","ynAmount","phProduct","phAmount"]
        .forEach(id => el(id).value = "");

      el("addYN").value = "";
      el("phAction").value = "";
      el("ynUnit").value = "g";
      el("phUnit").value = "g";

      el("ynFields").style.display = "none";
      el("phFields").style.display = "none";
    }

    /* =========================
       Rendering
       ========================= */

    function renderMeta(log){
      el("logMeta").innerHTML = `
        <p><strong>${log.mash_name}</strong></p>
        <p>Fill: ${log.fill_gal} gal</p>
        <p>Mode: ${log.mode}</p>
        <p>Started: ${new Date(log.mash_started_at).toLocaleString()}</p>
        ${log.sour_mash ? "<p><strong>Sour Mash</strong></p>" : ""}
      `;
    }

    function renderEntries(entries){
      if (!entries.length) {
        el("entries").innerHTML = "<p class='muted'>No entries yet.</p>";
        return;
      }

      el("entries").innerHTML = entries.map(e => `
        <div class="panel" style="margin-bottom:12px;">

          <div class="muted" style="margin-bottom:6px;">
            ${e._saving ? "Saving‚Ä¶" : e._error ? "‚ö†Ô∏è Not saved" : new Date(e.timestamp).toLocaleString()}
          </div>

          <div style="font-weight:500;margin-bottom:6px;">
            pH ${e.ph || "‚Äî"} ¬∑
            SG ${e.sg || "‚Äî"} ¬∑
            Temp ${e.temp_f || "‚Äî"}¬∞F
          </div>

          ${e.yn_type ? `
            <div style="margin-top:6px;">
              <strong>‚ûï ${e.yn_type === "yeast" ? "Yeast added" : "Nutrient added"}</strong><br>
              ${e.yn_product} ‚Äî ${e.yn_amount}${e.yn_unit}
            </div>
          ` : ""}

          ${e.ph_action ? `
            <div style="margin-top:6px;">
              <strong>üß™ pH adjusted (${e.ph_action})</strong><br>
              ${e.ph_product} ‚Äî ${e.ph_amount}${e.ph_unit}
            </div>
          ` : ""}

          ${e.notes ? `
            <div style="margin-top:6px;">
              <strong>üìù Notes</strong><br>
              ${e.notes}
            </div>
          ` : ""}

        </div>
      `).join("");
    }

    /* =========================
       Load logs + entries
       ========================= */

    async function populateLogSelect(){
      const sel = el("logSelect");
      sel.innerHTML = `<option value="">Select a mash log‚Ä¶</option>`;

      const logs = await window.getAllMashLogs();
      logs.forEach(l => {
        const o = document.createElement("option");
        o.value = l.log_id;
        o.textContent = `${l.mash_name} ‚Äî ${l.fill_gal} gal`;
        sel.appendChild(o);
      });
    }

    async function loadLog(logId){
  currentLogId = logId;
  el("logSection").style.display = "block";

  // show instant feedback
  el("entries").innerHTML = "<p class='muted'>Loading entries‚Ä¶</p>";

  const [log, entries] = await Promise.all([
    window.getMashLog(logId),
    window.getMashLogEntries(logId)
  ]);

  cachedEntries = entries;
  renderMeta(log);
  renderEntries(cachedEntries);
  resetEntryForm();
}
    /* =========================
       Add entry ‚Äî OPTIMISTIC UI
       ========================= */

    el("btnAddEntry").onclick = async () => {
      if (!currentLogId) return;

      const entry = {
        timestamp: new Date().toISOString(),

        ph: el("inPH").value,
        sg: el("inSG").value,
        temp_f: el("inTemp").value,
        notes: el("inNotes").value,

        yn_type: el("addYN").value,
        yn_product: el("ynProduct").value,
        yn_amount: el("ynAmount").value,
        yn_unit: el("ynUnit").value,

        ph_action: el("phAction").value,
        ph_product: el("phProduct").value,
        ph_amount: el("phAmount").value,
        ph_unit: el("phUnit").value,

        _saving: true
      };

      // optimistic render
      cachedEntries.unshift(entry);
      renderEntries(cachedEntries);
      resetEntryForm();

      try {
        await window.addMashLogEntry(currentLogId, entry);
        entry._saving = false;
        renderEntries(cachedEntries);
      } catch (err) {
        console.error(err);
        entry._saving = false;
        entry._error = true;
        renderEntries(cachedEntries);
        alert("Entry failed to save. Check connection.");
      }
    };

    /* =========================
       Init
       ========================= */
    populateLogSelect();
  </script>

</body>
</html>
