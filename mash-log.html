<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>797 Distillery ‚Äî Mash Log</title>

  <!-- Shared header -->
  <link rel="stylesheet" href="header.css?v=1.0.0" />

  <!-- Mash app css -->
  <link rel="stylesheet" href="mash.css?v=1.0.1" />
</head>

<body>

  <!-- GLOBAL HEADER -->
  <div id="global-header"></div>

  <script>
    const PAGE_TITLE = "Mash Log";
    const PAGE_SUBTITLE =
      "Live mash lifecycle journal (pH, SG, temperature, notes).";

    fetch("header.html?v=1.0.0")
      .then(r => r.text())
      .then(html => (document.getElementById("global-header").innerHTML = html))
      .catch(()=>{});
  </script>

  <main class="mash-container">

    <!-- LOG SELECTOR -->
    <div class="panel mash-panel">
      <h3>Select Mash Log</h3>
      <div id="logList" class="muted"></div>
    </div>

    <!-- META -->
    <div class="panel mash-panel">
      <h2>Mash Log</h2>
      <div id="logMeta" class="muted"></div>
    </div>

    <!-- ADD ENTRY -->
    <div class="panel mash-panel">
      <h3>Add Entry</h3>

      <div class="mash-grid">
        <div>
          <label>pH</label>
          <input id="inPH" type="number" step="0.01" />
        </div>
        <div>
          <label>SG</label>
          <input id="inSG" type="number" step="0.001" />
        </div>
        <div>
          <label>Temp (¬∞F)</label>
          <input id="inTemp" type="number" step="0.1" />
        </div>
        <div>
          <label>Notes</label>
          <input id="inNotes" type="text" />
        </div>
      </div>

      <!-- TOGGLES -->
      <div style="margin-top:14px;">
        <label><input type="checkbox" id="chkYeast" /> Yeast added</label><br/>
        <label><input type="checkbox" id="chkNutrient" /> Nutrient added</label><br/>
        <label><input type="checkbox" id="chkPH" /> pH adjusted</label>
      </div>

      <!-- YEAST -->
      <div id="yeastFields" class="mash-grid" hidden>
        <div><label>Yeast</label><input id="yeastProduct" type="text" /></div>
        <div><label>Amount</label><input id="yeastAmount" type="number" step="0.1" /></div>
        <div>
          <label>Unit</label>
          <select id="yeastUnit"><option value="g">g</option><option value="oz">oz</option></select>
        </div>
      </div>

      <!-- NUTRIENT -->
      <div id="nutrientFields" class="mash-grid" hidden>
        <div><label>Nutrient</label><input id="nutrientProduct" type="text" /></div>
        <div><label>Amount</label><input id="nutrientAmount" type="number" step="0.1" /></div>
        <div>
          <label>Unit</label>
          <select id="nutrientUnit"><option value="g">g</option><option value="oz">oz</option></select>
        </div>
      </div>

      <!-- PH ADJUST -->
      <div id="phFields" class="mash-grid" hidden>
        <div>
          <label>Direction</label>
          <select id="phDir"><option value="lower">Lower</option><option value="raise">Raise</option></select>
        </div>
        <div><label>Product</label><input id="phProduct" type="text" /></div>
        <div><label>Amount</label><input id="phAmount" type="number" step="0.1" /></div>
        <div>
          <label>Unit</label>
          <select id="phUnit"><option value="g">g</option><option value="ml">mL</option></select>
        </div>
      </div>

      <div style="margin-top:14px;">
        <button id="btnAddEntry">Add Entry</button>
      </div>
    </div>

    <!-- ENTRIES -->
    <div class="panel mash-panel">
      <h3>Log Entries</h3>
      <div id="entries"></div>
    </div>

    <div class="muted" style="margin-top:16px;text-align:right;">
      <span id="pageStamp"></span>
    </div>

  </main>

  <script src="mash-log.js"></script>

  <script>
    const PAGE_VERSION = "1.4";
    const PAGE_DATE = "2025-12-20";

    const el = id => document.getElementById(id);
    const qs = n => new URLSearchParams(location.search).get(n);

    let logId = qs("log");
    let currentLog = null;

    /* =========================
       Toggle behavior
       ========================= */
    const toggle = (chk, tgt) =>
      el(chk).onchange = () => el(tgt).hidden = !el(chk).checked;

    toggle("chkYeast", "yeastFields");
    toggle("chkNutrient", "nutrientFields");
    toggle("chkPH", "phFields");

    /* =========================
       Log selector
       ========================= */
    function getAllLogs(){
      try {
        return JSON.parse(localStorage.getItem("mash_logs_v1")) || [];
      } catch {
        return [];
      }
    }

    function renderLogList(activeId){
      const logs = getAllLogs();
      const wrap = el("logList");

      if (!logs.length) {
        wrap.innerHTML = "<p class='muted'>No mash logs found.</p>";
        return;
      }

      const active = [], archived = [];

      logs.forEach(l => {
        (l.meta?.status === "archived" ? archived : active).push(l);
      });

      const renderGroup = (title, list) =>
        list.length ? `
          <h4>${title}</h4>
          <ul>
            ${list.map(l => `
              <li>
                <a href="?log=${l.id}"
                   style="${l.id === activeId ? "font-weight:bold;" : ""}">
                  ${l.meta?.mashName || "Unnamed Mash"} ‚Äî ${l.meta?.fillGal ?? "?"} gal
                </a>
              </li>
            `).join("")}
          </ul>` : "";

      wrap.innerHTML =
        renderGroup("üü¢ Active Mash Logs", active) +
        renderGroup("üìÅ Archived Mash Logs", archived);
    }

    /* =========================
       Rendering
       ========================= */
    function renderMeta(log){
      el("logMeta").innerHTML = `
        <p><strong>${log.meta.mashName}</strong></p>
        <p>Fill: ${log.meta.fillGal} gal</p>
        <p>Mode: ${log.meta.mode}</p>
        <p>Started: ${new Date(log.created_at).toLocaleString()}</p>
      `;
    }

    function renderEntries(log){
      el("entries").innerHTML = (log.entries || []).map(e => `
        <div class="panel" style="margin-bottom:12px;">
          <div class="muted">${new Date(e.ts).toLocaleString()}</div>
          <div>pH: ${e.ph ?? "‚Äî"} | SG: ${e.sg ?? "‚Äî"} | Temp: ${e.temp ?? "‚Äî"}¬∞F</div>
          ${e.additions ? `
            <ul>
              ${e.additions.yeast ? `<li>Yeast: ${e.additions.yeast.product} (${e.additions.yeast.amount}${e.additions.yeast.unit})</li>` : ""}
              ${e.additions.nutrient ? `<li>Nutrient: ${e.additions.nutrient.product} (${e.additions.nutrient.amount}${e.additions.nutrient.unit})</li>` : ""}
              ${e.additions.phAdjust ? `<li>pH ${e.additions.phAdjust.direction}: ${e.additions.phAdjust.product} (${e.additions.phAdjust.amount}${e.additions.phAdjust.unit})</li>` : ""}
            </ul>` : ""}
          ${e.notes ? `<div>${e.notes}</div>` : ""}
        </div>
      `).join("");
    }

    function loadLog(id){
      currentLog = window.getMashLog(id);
      if (!currentLog) return;

      logId = id;
      renderMeta(currentLog);
      renderEntries(currentLog);
      renderLogList(logId);
    }

    /* =========================
       Add entry
       ========================= */
    el("btnAddEntry").onclick = () => {
      if (!currentLog) return alert("Select a mash log first.");

      const entry = {
        ph: el("inPH").value || null,
        sg: el("inSG").value || null,
        temp: el("inTemp").value || null,
        notes: el("inNotes").value || "",
        additions: {}
      };

      if (el("chkYeast").checked)
        entry.additions.yeast = {
          product: el("yeastProduct").value,
          amount: el("yeastAmount").value,
          unit: el("yeastUnit").value
        };

      if (el("chkNutrient").checked)
        entry.additions.nutrient = {
          product: el("nutrientProduct").value,
          amount: el("nutrientAmount").value,
          unit: el("nutrientUnit").value
        };

      if (el("chkPH").checked)
        entry.additions.phAdjust = {
          direction: el("phDir").value,
          product: el("phProduct").value,
          amount: el("phAmount").value,
          unit: el("phUnit").value
        };

      window.addMashLogEntry(logId, entry);
      loadLog(logId);
    };

    renderLogList(logId);
    if (logId) loadLog(logId);

    el("pageStamp").textContent =
      `Mash Log Page v${PAGE_VERSION} ‚Äî ${PAGE_DATE}`;
  </script>

</body>
</html>
