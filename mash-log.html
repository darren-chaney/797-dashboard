<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>797 Distillery — Mash Log</title>

  <!-- Shared header -->
  <link rel="stylesheet" href="header.css?v=1.0.0" />

  <!-- Mash app css -->
  <link rel="stylesheet" href="mash.css?v=1.0.1" />
</head>

<body>

  <!-- GLOBAL HEADER -->
  <div id="global-header"></div>

  <script>
    const PAGE_TITLE = "Mash Log";
    const PAGE_SUBTITLE =
      "Live mash lifecycle journal (pH, SG, temperature, notes).";

    fetch("header.html?v=1.0.0")
      .then(r => r.text())
      .then(html => (document.getElementById("global-header").innerHTML = html))
      .catch(()=>{});
  </script>

  <!-- =========================
       Page Container
       ========================= -->
  <main class="mash-container">

    <!-- META -->
    <div class="panel mash-panel">
      <h2>Mash Log</h2>
      <div id="logMeta" class="muted"></div>
    </div>

    <!-- ADD ENTRY -->
    <div class="panel mash-panel">
      <h3>Add Entry</h3>

      <div class="mash-grid">
        <div>
          <label>pH</label>
          <input id="inPH" type="number" step="0.01" placeholder="e.g. 5.4" />
        </div>

        <div>
          <label>SG</label>
          <input id="inSG" type="number" step="0.001" placeholder="e.g. 1.062" />
        </div>

        <div>
          <label>Temp (°F)</label>
          <input id="inTemp" type="number" step="0.1" placeholder="e.g. 148" />
        </div>

        <div>
          <label>Notes</label>
          <input id="inNotes" type="text" placeholder="optional notes…" />
        </div>
      </div>

      <div style="margin-top:12px;">
        <button id="btnAddEntry">Add Entry</button>
      </div>
    </div>

    <!-- ENTRIES -->
    <div class="panel mash-panel">
      <h3>Log Entries</h3>
      <div id="entries">
        <p class="muted">No entries yet.</p>
      </div>
    </div>

    <div class="muted" style="margin-top:16px;text-align:right;">
      <span id="pageStamp"></span>
    </div>

  </main>

  <!-- =========================
       Scripts
       ========================= -->
  <script src="mash-log.js"></script>

  <script>
    /* ============================================================
       Mash Log Page — Phase 4 (Entry UI)
       ============================================================ */

    const PAGE_VERSION = "1.1";
    const PAGE_DATE = "2025-12-20";

    const qs = n => new URLSearchParams(location.search).get(n);
    const logId = qs("log");

    const el = id => document.getElementById(id);

    function renderMeta(log){
      el("logMeta").innerHTML = `
        <p><strong>${log.meta.mashName || "Unnamed Mash"}</strong></p>
        <p>Fill: ${log.meta.fillGal ?? "—"} gal</p>
        <p>Mode: ${log.meta.mode ?? "—"}</p>
        <p>Started: ${new Date(log.created_at).toLocaleString()}</p>
        <hr />
        <p>
          Log Version: ${log.meta.logVersion || "1.0"}<br />
          Created By: ${log.meta.appVersion || "unknown"}
        </p>
      `;
    }

    function renderEntries(log){
      const wrap = el("entries");

      if (!log.entries || !log.entries.length) {
        wrap.innerHTML = `<p class="muted">No entries yet.</p>`;
        return;
      }

      wrap.innerHTML = log.entries.map(e => `
        <div class="panel" style="margin-bottom:12px;">
          <div class="muted" style="margin-bottom:6px;">
            ${new Date(e.ts).toLocaleString()}
          </div>
          <div>
            <div>pH: ${e.ph ?? "—"}</div>
            <div>SG: ${e.sg ?? "—"}</div>
            <div>Temp: ${e.temp ?? "—"} °F</div>
            ${e.notes ? `<div style="margin-top:6px;">${e.notes}</div>` : ""}
          </div>
        </div>
      `).join("");
    }

    function load(){
      if (!logId) {
        el("logMeta").innerHTML = "<p class='muted'>No mash log specified.</p>";
        return null;
      }
      const log = window.getMashLog(logId);
      if (!log) {
        el("logMeta").innerHTML = "<p class='muted'>Mash log not found.</p>";
        return null;
      }
      renderMeta(log);
      renderEntries(log);
      return log;
    }

    let currentLog = load();

    el("btnAddEntry").onclick = () => {
      if (!currentLog) return;

      const data = {
        ph: el("inPH").value ? Number(el("inPH").value) : null,
        sg: el("inSG").value ? Number(el("inSG").value) : null,
        temp: el("inTemp").value ? Number(el("inTemp").value) : null,
        notes: el("inNotes").value.trim()
      };

      window.addMashLogEntry(logId, data);

      // Clear inputs
      ["inPH","inSG","inTemp","inNotes"].forEach(id => el(id).value = "");

      currentLog = window.getMashLog(logId);
      renderEntries(currentLog);
    };

    el("pageStamp").textContent =
      `Mash Log Page v${PAGE_VERSION} — ${PAGE_DATE}`;
  </script>

</body>
</html>
