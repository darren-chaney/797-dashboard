<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>New Barrel Entry (TEST)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      background: #0f172a;
      color: #e5e7eb;
      font-family: system-ui, sans-serif;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    form {
      max-width: 500px;
      margin: 0 auto;
      background: #1e293b;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #334155;
    }

    label {
      display: block;
      margin-top: 15px;
      font-size: 0.9rem;
      color: #cbd5e1;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #475569;
      background: #0f172a;
      color: white;
    }

    button {
      margin-top: 20px;
      padding: 12px;
      width: 100%;
      font-size: 1rem;
      background: #38bdf8;
      color: black;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover {
      background: #7dd3fc;
    }
  </style>
</head>

<body>

  <h1>Enter New Barrel (TEST)</h1>

  <form id="barrelForm">

    <label>Barrel No.</label>
    <input type="text" name="Barrel No." required />

    <label>Fill Date</label>
    <input type="date" name="Fill Date" required />

    <label>Spirit Type</label>
    <select name="Spirit Type" required>
      <option value="Tennessee Whiskey">Tennessee Whiskey</option>
      <option value="Wheated Whiskey">Wheated Whiskey</option>
      <option value="Rum">Rum</option>
      <option value="Moonshine">Moonshine</option>
      <option value="Other">Other</option>
    </select>

    <label>Mash Bill</label>
    <input type="text" name="Mash Bill" />

    <label>Entry Proof</label>
    <input type="number" name="Entry Proof" required />

    <label>Gallons</label>
    <select name="Gallons" required>
      <option value="15">15 Gallon</option>
      <option value="53">53 Gallon</option>
    </select>

    <label>Lot ID (Auto – leave blank)</label>
    <input type="text" name="Lot ID" placeholder="Auto" disabled />

    <label>Barrel Type</label>
    <input type="text" name="Barrel Type" />

    <label>RC-G</label>
    <input type="text" name="RC-G" />

    <label>OPG (Auto Calculated)</label>
    <input type="number" name="OPG" placeholder="Auto" disabled />

    <label>Barrel Doc Link</label>
    <input type="text" name="Barrel Doc Link" />

    <label>Notes</label>
    <textarea name="Notes" rows="3"></textarea>

    <button type="submit">Submit Barrel</button>

  </form>

  <script>
    const API_URL = "https://api.sheetbest.com/sheets/62950420-e9fb-4453-a651-96bf566f2907";

    // ========== LIVE OPG CALCULATION ==========
    function updateOPG() {
      const proof = Number(document.querySelector('input[name="Entry Proof"]').value);
      const gallons = Number(document.querySelector('select[name="Gallons"]').value);

      if (!isNaN(proof) && !isNaN(gallons) && proof > 0 && gallons > 0) {
        const opg = (proof * gallons) / 100;
        document.querySelector('input[name="OPG"]').value = opg.toFixed(2);
      }
    }

    document.querySelector('input[name="Entry Proof"]').addEventListener("input", updateOPG);
    document.querySelector('select[name="Gallons"]').addEventListener("change", updateOPG);
    // ==== RC-G Auto Changes ====
    // Auto-set RC-G based on Gallons selection
  document.querySelector('select[name="Gallons"]').addEventListener("change", () => {
  const gallons = document.querySelector('select[name="Gallons"]').value;
  const rcgField = document.querySelector('select[name="RC-G"]');

  if (gallons === "15") rcgField.value = "15.0";
  if (gallons === "53") rcgField.value = "53.0";
});

    // ===== AUTO-GENERATE LOT ID BASED ON TODAY =====
function generateLotID() {
  const today = new Date();

  const year = String(today.getFullYear()).slice(-2); // last 2 digits
  const monthIndex = today.getMonth();                // 0–11
  const day = String(today.getDate()).padStart(2, "0");

  // Cooperage month letters
  const monthLetters = ["A","B","C","D","E","F","G","H","I","J","K","L"];
  const monthLetter = monthLetters[monthIndex];

  const lotID = `${year}${monthLetter}${day}`;

  document.querySelector('input[name="Lot ID"]').value = lotID;
}

generateLotID();

    // ===== AUTO-FILL NEXT BARREL NUMBER =====
    async function loadNextBarrelNumber() {
    try {
      const response = await fetch(API_URL, {
        method: "GET",
        headers: {
        "Accept": "application/json",
        "X-Api-Key": API_KEY
      }
    });

    const rows = await response.json();

    if (!Array.isArray(rows) || rows.length === 0) return;

    // Get last non-empty Barrel No.
    let last = rows[rows.length - 1]["Barrel No."];

    // Convert to number
    let lastNum = parseInt(last);

    if (!isNaN(lastNum)) {
      document.querySelector('input[name="Barrel No."]').value = lastNum + 1;
    }

  } catch (err) {
    console.error("Error loading next barrel number:", err);
  }
}

loadNextBarrelNumber();


    // ========== FORM SUBMISSION ==========
    document.getElementById("barrelForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const form = new FormData(e.target);
      const data = Object.fromEntries(form);

      // force-send the disabled fields too
      data["OPG"] = document.querySelector('input[name="OPG"]').value;
      data["Lot ID"] = document.querySelector('input[name="Lot ID"]').value;

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          alert("Barrel successfully recorded!");
          location.reload();
        } else {
          alert("Error submitting to Sheet.best.");
        }

      } catch (err) {
        alert("Request Failed: " + err);
      }
    });
  </script>

</body>
</html>
