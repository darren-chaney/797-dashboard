<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>797 Distillery – Print Barrel Label</title>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<style>
:root{
  --bg:#0f172a;
  --panel:#111c33;
  --border:#334155;
  --text:#e5e7eb;
}

/* ================= BASE ================= */
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}

.container{
  max-width:1100px;
  margin:0 auto;
  padding:18px;
}

/* ================= HEADER ================= */
#headerMount{max-height:90px;overflow:hidden}
#headerMount img{max-height:48px;width:auto}
#headerMount *{margin:0!important}

/* ================= CONTROLS ================= */
.controls{
  background:#111c33;
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px;
  display:grid;
  grid-template-columns:1fr auto auto auto;
  gap:10px;
}

select,button{
  padding:10px 12px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#0b1222;
  color:var(--text);
  font-weight:700;
}

button{cursor:pointer}
button:disabled{opacity:.5;cursor:not-allowed}

/* ================= LABEL ================= */
#printArea{
  margin-top:16px;
}

.label{
  width:6in;
  height:4in;
  background:#fff;
  color:#000;
  padding:0.25in;
  box-sizing:border-box;
  font-family:Arial,Helvetica,sans-serif;
  display:none;
}

.lbl-header{
  display:flex;
  align-items:center;
  gap:14px;
}

.lbl-r{
  font-size:92px;
  font-weight:900;
  line-height:1;
}

.lbl-title{font-size:18px;font-weight:800}
.lbl-dsp{font-weight:800;margin-top:2px}

.lbl-rule{
  border-top:3px solid #000;
  margin:10px 0;
}

.lbl-data{
  font-size:14px;
  line-height:1.6;
}
.lbl-data span{
  display:inline-block;
  width:180px;
  font-weight:700;
}

/* ===== LOGO ===== */
.lbl-crest{
  text-align:center;
}
.crest-img{
  height:260px;            /* FINAL correct size */
  width:auto;
  max-width:100%;
  display:block;
  margin:8px auto;
  object-fit:contain;
}

/* ===== BARREL ===== */
.lbl-barrel{
  text-align:center;
  font-size:28px;
  font-weight:900;
}

/* ===== QR ===== */
.lbl-qr{
  display:flex;
  justify-content:center;
}
.lbl-qr canvas,
.lbl-qr img{
  width:150px;
  height:150px;
}

/* ================= PRINT ================= */
@page{
  size:6in 4in;
  margin:0;
}

@media print{
  html,body{
    width:6in;
    height:4in;
    margin:0;
    padding:0;
    overflow:hidden;
    background:#fff;
  }

  body *{visibility:hidden}

  #printArea,
  #printArea *{
    visibility:visible;
  }

  #printArea{
    position:absolute;
    inset:0;
    width:6in;
    height:4in;
  }

  .no-print{display:none!important}
}
</style>
</head>

<body>
<div class="container">

  <!-- HEADER -->
  <div id="headerMount" class="no-print"></div>

  <!-- CONTROLS -->
  <div class="controls no-print">
    <select id="barrelSelect">
      <option>Loading barrels…</option>
    </select>
    <button id="btnGenerate">Generate</button>
    <button id="btnPrint" disabled>Print</button>
    <button id="btnClear">Clear</button>
  </div>

  <!-- PRINT AREA -->
  <div id="printArea">
    <div id="label" class="label">

      <div class="lbl-header">
        <div class="lbl-r">R</div>
        <div>
          <div class="lbl-title">797 Distillery LLC</div>
          <div>425 E Pleasant Ave</div>
          <div>Covington, Tennessee 38019</div>
          <div class="lbl-dsp">DSP-TN-21154</div>
        </div>
      </div>

      <div class="lbl-rule"></div>

      <div class="lbl-data">
        <div><span>First Fill Date:</span> <b id="vFillDate"></b></div>
        <div><span>Mash Bill:</span> <b id="vMashBill"></b></div>
        <div><span>Product Name:</span> <b id="vSpiritType"></b></div>
        <div><span>Entry Proof:</span> <b id="vEntryProof"></b></div>
        <div><span>Lot Identification No:</span> <b id="vLotId"></b></div>
        <div><span>RC-G:</span> <b id="vRCG"></b></div>
        <div><span>OPG:</span> <b id="vOPG"></b></div>
        <div><span>Barrel Type:</span> <b id="vBarrelType"></b></div>
      </div>

      <div class="lbl-rule"></div>

      <div class="lbl-crest">
        <img src="websiteLogoGlass.png" class="crest-img" alt="797 Distillery Logo">
      </div>

      <div class="lbl-rule"></div>

      <div class="lbl-barrel">
        Barrel # <span id="vBarrelNo"></span>
      </div>

      <div class="lbl-rule"></div>

      <div class="lbl-qr">
        <div id="qrcode"></div>
      </div>

    </div>
  </div>
</div>

<script>
const BARREL_STORAGE_CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vSNyLVIgK_UeIZdZQJaGF3IgiqZ68aCG0tydTzszngpgYhu4-HlLXNHotuGPJOA63CKSs-RkZgGtRpt/pub?output=csv";

async function loadHeader(){
  try{
    const r=await fetch("header.html",{cache:"no-store"});
    headerMount.innerHTML=await r.text();
  }catch{}
}

function parseCSV(t){
  const [h,...lines]=t.split(/\r?\n/);
  const headers=h.split(",");
  return lines.filter(l=>l.trim()).map(l=>{
    const o={},c=l.split(",");
    headers.forEach((k,i)=>o[k.trim()]=c[i]?.trim()||"");
    return o;
  });
}

function makeQR(url){
  qrcode.innerHTML="";
  if(url)new QRCode(qrcode,{text:url,width:150,height:150});
}

const barrels=new Map();

async function loadBarrels(){
  const r=await fetch(BARREL_STORAGE_CSV_URL);
  const rows=parseCSV(await r.text());
  rows.forEach(o=>barrels.set(o["Barrel No."],o));
  barrelSelect.innerHTML='<option value="">Select barrel…</option>'+
    [...barrels.keys()].sort().map(b=>`<option>${b}</option>`).join("");
}

function fillLabel(o){
  vBarrelNo.textContent=o["Barrel No."];
  vFillDate.textContent=o["Fill Date"];
  vMashBill.textContent=o["Mash Bill"];
  vSpiritType.textContent=o["Spirit Type"];
  vEntryProof.textContent=o["Entry Proof"];
  vLotId.textContent=o["Lot ID"];
  vRCG.textContent=o["RC-G"];
  vOPG.textContent=o["OPG"];
  vBarrelType.textContent=o["Barrel Type"];
  makeQR(o["Barrel Doc Link"]);
  label.style.display="block";
  btnPrint.disabled=false;
}

btnGenerate.onclick=()=>{
  const o=barrels.get(barrelSelect.value);
  if(o)fillLabel(o);
};

btnClear.onclick=()=>{
  label.style.display="none";
  btnPrint.disabled=true;
  qrcode.innerHTML="";
};

btnPrint.onclick=()=>window.print();

(async()=>{
  await loadHeader();
  await loadBarrels();
})();
</script>
</body>
</html>
