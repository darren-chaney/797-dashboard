<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Recipe Scaling</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared Header CSS -->
  <link rel="stylesheet" href="header.css" />

  <!-- Scaling Engine -->
  <script src="scaler.js"></script>

  <style>
    body{
      margin:0;
      background:#0f172a;
      color:#e5e7eb;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    main{
      max-width:1000px;
      margin:0 auto;
      padding:32px 20px;
    }
    h1{font-size:1.7rem;margin:0 0 6px}
    .subtitle{color:#9ca3af;margin-bottom:22px}

    .panel{
      background:#111c33;
      border:1px solid #334155;
      border-radius:12px;
      padding:20px;
      margin-bottom:18px;
    }
    .panel h2{font-size:1.05rem;margin:0 0 14px}

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(160px, max-content));
      gap:20px;
      align-items:end;
    }

    .grid > div{
      display:flex;
      flex-direction:column;
    }

    input[type="number"]{
      text-align:right;
    }

    label{
      font-size:.85rem;
      color:#cbd5e1;
      margin-bottom:6px;
    }

    select,input{
      padding:10px;
      border-radius:8px;
      border:1px solid #334155;
      background:#0f172a;
      color:#e5e7eb;
      font-size:.95rem;
    }

    .results{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(210px,1fr));
      gap:14px;
      margin-top:10px;
    }

    .result{
      background:#0b1220;
      border:1px solid #334155;
      border-radius:12px;
      padding:16px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
    }

    .k{font-size:.75rem;color:#9ca3af;margin-bottom:4px}
    .v{font-size:1.2rem;font-weight:700}
    .muted{color:#9ca3af;font-size:.85rem}

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #475569;
      background:#0f172a;
      font-size:.78rem;
      margin-top:8px;
    }

    .results-version{
      margin-top:12px;
      font-size:.72rem;
      color:#9ca3af;
      opacity:.7;
      text-align:right;
    }
  </style>
</head>

<body>

<div id="global-header"></div>

<script>
  /* =========================
     PAGE CONFIG
     ========================= */
  const APP_VERSION = "v1.4.2";

  const PAGE_TITLE = "Recipe Scaling";
  const PAGE_SUBTITLE = "Wizard scaling from approved base recipes.";

  fetch("header.html",{cache:"no-store"})
    .then(r=>r.text())
    .then(html=>{
      document.getElementById("global-header").innerHTML=html;
      document.getElementById("page-title").textContent=PAGE_TITLE;
      document.getElementById("page-subheading").textContent=PAGE_SUBTITLE;

      if (typeof setActiveModule === "function") {
        setActiveModule("products");
      }
    });
</script>

<main>
  <h1>Recipe Scaling</h1>
  <div class="subtitle">Scale approved recipes from base spirit usage</div>

  <!-- STEP 1 -->
  <section class="panel">
    <h2>Step 1 â€” Select Recipe</h2>
    <select id="recipe"></select>
    <div class="pill" id="recipeMeta">â€”</div>

    <!-- RECIPE SUMMARY -->
    <div id="recipeSummary" class="results"></div>
  </section>

  <!-- STEP 2 -->
  <section class="panel">
    <h2>Step 2 â€” Base Spirit Used</h2>
    <div class="grid">
      <div>
        <label>Gallons of Base Spirit</label>
        <input id="baseGallons" type="number" step="0.01">
      </div>
      <div>
        <label>Base Proof</label>
        <input id="baseProof" type="number">
      </div>
      <div>
        <label>Final Proof</label>
        <input id="finalProof" type="number">
      </div>
      <div>
        <label>Sweetness % (HFCS v/v)</label>
        <input id="sweetPercent" type="number" step="0.1" min="0" max="30">
      </div>
    </div>

    <div class="muted" style="margin-top:10px;">
      Sweetness % defaults from the recipe, but you can override it here (ex: 12.0 vs 14.0).
    </div>
  </section>

  <!-- RESULTS -->
  <section class="panel">
    <h2>Results</h2>
    <div id="results" class="results"></div>
    <div class="results-version">
      Recipe Scaling â€¢ <span id="app-version"></span>
    </div>
  </section>
</main>

<script>
/* =========================
   RECIPE DEFINITIONS
   ========================= */

const RECIPES = {
  margarita: {
    name: "Margarita Moonshine",
    base: { gallons: 4, proof: 164 },
    final: { proof: 60 },
    ingredients: [
      { name:"HFCS 42", type:"percent_vv", percent:0.14, densityKgPerL:1.613 },
      { name:"Apex Margarita Flavor", type:"liquid", amount:232, unit:"mL" },
      { name:"Apex Orange Extract", type:"liquid", amount:39, unit:"mL" },
      { name:"Citric Acid", type:"solid", amount:27, unit:"g" },
      { name:"Malic Acid", type:"solid", amount:8, unit:"g" }
    ]
  },

  spicy_pineapple: {
    name: "Spicy Pineapple Moonshine",
    base: { gallons: 5, proof: 155 },
    final: { proof: 60 },
    ingredients: [
      /* ðŸ‘‡ SET THIS TO 0.12 IF SPICY PINEAPPLE IS 12% */
      { name:"HFCS 42", type:"percent_vv", percent:0.12, densityKgPerL:1.613 },
      { name:"Apex Pineapple Flavor (Natural & Artificial)", type:"liquid", amount:420, unit:"mL" },
      { name:"Apex Capsicum Natural Extract", type:"liquid", amount:12, unit:"mL" },
      { name:"Citric Acid", type:"solid", amount:27, unit:"g" },
      { name:"Malic Acid", type:"solid", amount:8, unit:"g" }
    ]
  }
};

const GAL_TO_L = 3.785411784;

// formatting helpers
const fmt = (n,d=3)=>Number(n).toFixed(d);
const fmt0 = (n)=>Number(n).toFixed(0);
const fmt1 = (n)=>Number(n).toFixed(1);

document.getElementById("app-version").textContent = APP_VERSION;

const recipeSelect = document.getElementById("recipe");
const recipeMeta = document.getElementById("recipeMeta");
const recipeSummary = document.getElementById("recipeSummary");

const baseGallonsInput = document.getElementById("baseGallons");
const baseProofInput = document.getElementById("baseProof");
const finalProofInput = document.getElementById("finalProof");
const sweetPercentInput = document.getElementById("sweetPercent");

const resultsDiv = document.getElementById("results");

Object.entries(RECIPES).forEach(([key,r])=>{
  const o=document.createElement("option");
  o.value=key;
  o.textContent=r.name;
  recipeSelect.appendChild(o);
});

function getRecipeHFCS(r){
  const hfcs = r.ingredients.find(i => i.type === "percent_vv");
  if (!hfcs) throw new Error("Recipe missing HFCS percent_vv ingredient.");
  return hfcs;
}

function renderRecipeSummary(r, effectivePct01){
  const hfcs = getRecipeHFCS(r);
  const pct = (typeof effectivePct01 === "number" ? effectivePct01 : hfcs.percent) * 100;

  recipeSummary.innerHTML = `
    <div class="result">
      <div class="k">Canonical Base</div>
      <div class="v">${r.base.gallons} gal @ ${r.base.proof}</div>
    </div>
    <div class="result">
      <div class="k">Final Proof</div>
      <div class="v">${r.final.proof}</div>
    </div>
    <div class="result">
      <div class="k">Sweetness</div>
      <div class="v">${fmt1(pct)}% HFCS-42</div>
    </div>
  `;
}

function loadRecipe(){
  const r = RECIPES[recipeSelect.value];
  const hfcs = getRecipeHFCS(r);

  baseGallonsInput.value = r.base.gallons;
  baseProofInput.value   = r.base.proof;
  finalProofInput.value  = r.final.proof;

  // Default sweetness from recipe (editable)
  sweetPercentInput.value = fmt1(hfcs.percent * 100);

  recipeMeta.textContent =
    `${r.base.gallons} gal @ ${r.base.proof} â†’ ${r.final.proof} proof`;

  renderRecipeSummary(r, hfcs.percent);
}

function runWizard(){
  const r = RECIPES[recipeSelect.value];
  const hfcs = getRecipeHFCS(r);

  const baseGallons = Number(baseGallonsInput.value);
  const baseProof   = Number(baseProofInput.value);
  const finalProof  = Number(finalProofInput.value);

  // sweetness override (percent typed by user)
  let sweetPct01 = Number(sweetPercentInput.value) / 100;
  if (!isFinite(sweetPct01) || sweetPct01 <= 0) {
    sweetPct01 = hfcs.percent; // fall back to recipe
  }

  if(!baseGallons || !baseProof || !finalProof){
    resultsDiv.innerHTML = `<div class="muted">Enter valid inputs.</div>`;
    return;
  }

  const scaled = Scaler.scaleFromBase({
    baseGallons,
    baseProof,
    targetProof: finalProof
  });

  const multiplier = baseGallons / r.base.gallons;

  // HFCS computed from effective sweetness percent
  const hfcsVolumeGal = scaled.finalVolume * sweetPct01;
  const hfcsKg = hfcsVolumeGal * GAL_TO_L * hfcs.densityKgPerL;

  // water = final - base - hfcs (flavors/acids excluded)
  const waterGal = scaled.finalVolume - baseGallons - hfcsVolumeGal;

  // render ingredients (non-HFCS scale linearly)
  const ingredientBlocks = r.ingredients
    .filter(i => i.type !== "percent_vv")
    .map(i=>{
      const amt = i.amount * multiplier;

      if(i.type === "liquid"){
        return `
          <div class="result">
            <div class="k">${i.name}</div>
            <div class="v">${fmt0(amt)} ${i.unit}</div>
            <div class="muted">Ã— ${fmt(multiplier,4)}</div>
          </div>
        `;
      }

      if(i.type === "solid"){
        return `
          <div class="result">
            <div class="k">${i.name}</div>
            <div class="v">${fmt(amt,3)} ${i.unit}</div>
            <div class="muted">Ã— ${fmt(multiplier,4)}</div>
          </div>
        `;
      }

      return "";
    }).join("");

  resultsDiv.innerHTML = `
    <div class="result">
      <div class="k">Water Required</div>
      <div class="v">${fmt(waterGal)} gal</div>
    </div>

    <div class="result">
      <div class="k">Final Volume</div>
      <div class="v">${fmt(scaled.finalVolume)} gal</div>
    </div>

    <div class="result">
      <div class="k">Alcohol Content</div>
      <div class="v">${fmt(scaled.alcoholPG,2)} PG</div>
    </div>

    <div class="result">
      <div class="k">HFCS 42</div>
      <div class="v">${fmt(hfcsKg,2)} kg</div>
      <div class="muted">${fmt1(sweetPct01*100)}% v/v (â‰ˆ ${fmt(hfcsVolumeGal)} gal)</div>
    </div>

    ${ingredientBlocks}
  `;

  // keep summary reflecting the effective sweetness
  renderRecipeSummary(r, sweetPct01);
}

recipeSelect.addEventListener("change",()=>{ loadRecipe(); runWizard(); });
[baseGallonsInput, baseProofInput, finalProofInput, sweetPercentInput]
  .forEach(el => el.addEventListener("input", runWizard));

loadRecipe();
runWizard();
</script>

</body>
</html>
