<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Recipe Scaling</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared Header CSS -->
  <link rel="stylesheet" href="header.css" />

  <!-- Scaling Engine -->
  <script src="scaler.js"></script>

  <style>
    body{
      margin:0;
      background:#0f172a;
      color:#e5e7eb;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    main{
      max-width:1000px;
      margin:0 auto;
      padding:32px 20px;
    }

    h1{
      font-size:1.7rem;
      margin:0 0 6px 0;
    }

    .subtitle{
      color:#9ca3af;
      margin-bottom:22px;
    }

    .panel{
      background:#111c33;
      border:1px solid #334155;
      border-radius:12px;
      padding:20px;
      margin-bottom:18px;
    }

    .panel h2{
      font-size:1.05rem;
      margin:0 0 14px 0;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
      gap:14px;
    }

    label{
      display:block;
      font-size:.85rem;
      color:#cbd5e1;
      margin-bottom:6px;
    }

    select, input{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid #334155;
      background:#0f172a;
      color:#e5e7eb;
      font-size:.95rem;
      outline:none;
    }

    input:focus, select:focus{
      border-color:#64748b;
    }

    .results{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(210px, 1fr));
      gap:14px;
      margin-top:10px;
    }

    .result{
      background:#0f1e3a;
      border:1px solid #475569;
      border-radius:10px;
      padding:14px;
    }

    .result .k{
      font-size:.75rem;
      color:#9ca3af;
      margin-bottom:4px;
    }

    .result .v{
      font-size:1.15rem;
      font-weight:650;
      letter-spacing:.2px;
    }

    .muted{
      color:#9ca3af;
      font-size:.85rem;
      line-height:1.35;
    }

    .rowline{
      height:1px;
      background:#334155;
      margin:14px 0;
    }

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #475569;
      background:#0f172a;
      color:#cbd5e1;
      font-size:.78rem;
      margin-top:8px;
    }
  </style>
</head>

<body>

  <!-- GLOBAL HEADER -->
  <div id="global-header"></div>

  <script>
    const PAGE_TITLE = "Recipe Scaling";
    const PAGE_SUBTITLE = "Wizard scaling from approved base recipes.";

    fetch("header.html", { cache: "no-store" })
      .then(res => res.text())
      .then(html => {
        document.getElementById("global-header").innerHTML = html;

        const title = document.getElementById("page-title");
        const subtitle = document.getElementById("page-subheading");

        if (title) title.textContent = PAGE_TITLE;
        if (subtitle) subtitle.textContent = PAGE_SUBTITLE;

        setActiveModule("products");
      });
  </script>

  <main>
    <h1>Recipe Scaling</h1>
    <div class="subtitle">Select a recipe, enter base gallons, get exact water + scaled ingredients.</div>

    <!-- STEP 1: RECIPE -->
    <section class="panel">
      <h2>Step 1 — Select Recipe</h2>
      <div class="grid">
        <div>
          <label for="recipe">Recipe</label>
          <select id="recipe"></select>
          <div class="pill" id="recipeMeta">—</div>
        </div>
      </div>
      <div class="muted" style="margin-top:10px;">
        This wizard assumes the recipe defines a canonical base (ex: 4 gal @ 155 proof) and a fixed final proof (ex: 60).
      </div>
    </section>

    <!-- STEP 2: BASE INPUT -->
    <section class="panel">
      <h2>Step 2 — Base Spirit Used</h2>
      <div class="grid">
        <div>
          <label for="baseGallons">Gallons of Base Spirit</label>
          <input id="baseGallons" type="number" step="0.01" value="4" />
        </div>

        <div>
          <label for="baseProof">Base Proof</label>
          <input id="baseProof" type="number" step="1" value="155" />
        </div>

        <div>
          <label for="finalProof">Final Proof</label>
          <input id="finalProof" type="number" step="1" value="60" />
        </div>
      </div>

      <div class="muted" style="margin-top:10px;">
        Base Proof and Final Proof are auto-filled by the recipe, but you can override for special cases.
      </div>
    </section>

    <!-- RESULTS -->
    <section class="panel">
      <h2>Results</h2>
      <div id="results" class="results"></div>

      <div class="rowline"></div>

      <div class="muted">
        Ingredient units come from the recipe book:
        <strong>Flavoring = mL</strong>, <strong>Sweetener = kg</strong>.
        Water and volume are calculated in <strong>gallons</strong>.
      </div>
    </section>
  </main>

  <script>
    // =========================================================
    // RECIPE DATA (Step 2 will expand this — start small)
    // Notes:
    // - flavorMl and sweetenerKg are placeholders until you paste real numbers
    // - base + final are the authoritative proof targets for math
    // =========================================================
    const RECIPES = {
      // Replace placeholder amounts with your Master Recipe Book numbers.
      apple_pie: {
        name: "Apple Pie Moonshine",
        base: { gallons: 4, proof: 155 },
        final: { proof: 60 },
        ingredients: { flavorMl: 0, sweetenerKg: 0 }
      },
      blue_raspberry: {
        name: "Blue Raspberry Moonshine",
        base: { gallons: 4, proof: 155 },
        final: { proof: 60 },
        ingredients: { flavorMl: 0, sweetenerKg: 0 }
      }
    };

    const recipeSelect = document.getElementById("recipe");
    const recipeMeta = document.getElementById("recipeMeta");
    const baseGallonsInput = document.getElementById("baseGallons");
    const baseProofInput = document.getElementById("baseProof");
    const finalProofInput = document.getElementById("finalProof");
    const resultsDiv = document.getElementById("results");

    // Populate dropdown
    Object.entries(RECIPES).forEach(([key, r]) => {
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = r.name;
      recipeSelect.appendChild(opt);
    });

    function setInputsFromRecipe() {
      const r = RECIPES[recipeSelect.value];
      if (!r) return;

      baseGallonsInput.value = r.base.gallons;
      baseProofInput.value = r.base.proof;
      finalProofInput.value = r.final.proof;

      recipeMeta.textContent =
        `${r.base.gallons} gal @ ${r.base.proof} proof → ${r.final.proof} proof`;
    }

    function runWizard() {
      const r = RECIPES[recipeSelect.value];
      if (!r) return;

      const baseGallons = Number(baseGallonsInput.value);
      const baseProof = Number(baseProofInput.value);
      const finalProof = Number(finalProofInput.value);

      if (!baseGallons || !baseProof || !finalProof) {
        resultsDiv.innerHTML = `<div class="muted">Enter valid base gallons and proofs.</div>`;
        return;
      }

      // =========================================================
      // STEP 1 REFACTOR COMPLETE:
      // All base → water → final volume math comes from scaler.js
      // =========================================================
      let scaledBase;
      try {
        scaledBase = Scaler.scaleFromBase({
          baseGallons,
          baseProof,
          targetProof: finalProof
        });
      } catch (e) {
        resultsDiv.innerHTML = `<div class="muted">${e.message}</div>`;
        return;
      }

      // Recipe multiplier (ingredient scaling)
      const multiplier = baseGallons / r.base.gallons;

      // Ingredient scaling (units match Master Recipe Book)
      const flavorMl = (r.ingredients?.flavorMl || 0) * multiplier;
      const sweetenerKg = (r.ingredients?.sweetenerKg || 0) * multiplier;

      resultsDiv.innerHTML = `
        <div class="result">
          <div class="k">Water Required</div>
          <div class="v">${scaledBase.waterGallons} gal</div>
        </div>

        <div class="result">
          <div class="k">Final Volume</div>
          <div class="v">${scaledBase.finalVolume} gal</div>
        </div>

        <div class="result">
          <div class="k">Alcohol Content</div>
          <div class="v">${scaledBase.alcoholPG} PG</div>
        </div>

        <div class="result">
          <div class="k">Flavoring</div>
          <div class="v">${flavorMl.toFixed(0)} mL</div>
          <div class="muted">Scaled × ${multiplier.toFixed(3)}</div>
        </div>

        <div class="result">
          <div class="k">Sweetener</div>
          <div class="v">${sweetenerKg.toFixed(3)} kg</div>
          <div class="muted">Scaled × ${multiplier.toFixed(3)}</div>
        </div>
      `;
    }

    // Events
    recipeSelect.addEventListener("change", () => {
      setInputsFromRecipe();
      runWizard();
    });

    [baseGallonsInput, baseProofInput, finalProofInput].forEach(el => {
      el.addEventListener("input", runWizard);
    });

    // Init
    setInputsFromRecipe();
    runWizard();
  </script>

</body>
</html>
