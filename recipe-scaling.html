<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Recipe Scaling</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="header.css" />
  <script src="scaler.js"></script>

  <style>
    body{
      margin:0;
      background:#0f172a;
      color:#e5e7eb;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    main{
      max-width:1000px;
      margin:0 auto;
      padding:32px 20px;
    }
    h1{font-size:1.7rem;margin:0 0 6px}
    .subtitle{color:#9ca3af;margin-bottom:22px}
    .panel{
      background:#111c33;
      border:1px solid #334155;
      border-radius:12px;
      padding:20px;
      margin-bottom:18px;
    }
    .panel h2{font-size:1.05rem;margin:0 0 14px}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:14px;
    }
    label{
      display:block;
      font-size:.85rem;
      color:#cbd5e1;
      margin-bottom:6px;
    }
    select,input{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid #334155;
      background:#0f172a;
      color:#e5e7eb;
      font-size:.95rem;
    }
    .results{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(210px,1fr));
      gap:14px;
      margin-top:10px;
    }
    .result{
      background:#0f1e3a;
      border:1px solid #475569;
      border-radius:10px;
      padding:14px;
    }
    .k{font-size:.75rem;color:#9ca3af;margin-bottom:4px}
    .v{font-size:1.15rem;font-weight:650}
    .muted{color:#9ca3af;font-size:.85rem}
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #475569;
      background:#0f172a;
      font-size:.78rem;
      margin-top:8px;
    }
  </style>
</head>

<body>

<div id="global-header"></div>

<script>
  const PAGE_TITLE = "Recipe Scaling";
  const PAGE_SUBTITLE = "Wizard scaling from approved base recipes.";

  fetch("header.html",{cache:"no-store"})
    .then(r=>r.text())
    .then(html=>{
      document.getElementById("global-header").innerHTML=html;
      document.getElementById("page-title").textContent=PAGE_TITLE;
      document.getElementById("page-subheading").textContent=PAGE_SUBTITLE;
      setActiveModule("products");
    });
</script>

<main>
  <h1>Recipe Scaling</h1>
  <div class="subtitle">Scale approved recipes from base spirit usage</div>

  <!-- STEP 1 -->
  <section class="panel">
    <h2>Step 1 — Select Recipe</h2>
    <select id="recipe"></select>
    <div class="pill" id="recipeMeta">—</div>
  </section>

  <!-- STEP 2 -->
  <section class="panel">
    <h2>Step 2 — Base Spirit Used</h2>
    <div class="grid">
      <div>
        <label>Gallons of Base Spirit</label>
        <input id="baseGallons" type="number" step="0.01">
      </div>
      <div>
        <label>Base Proof</label>
        <input id="baseProof" type="number">
      </div>
      <div>
        <label>Final Proof</label>
        <input id="finalProof" type="number">
      </div>
    </div>
  </section>

  <!-- RESULTS -->
  <section class="panel">
    <h2>Results</h2>
    <div id="results" class="results"></div>
  </section>
</main>

<script>
/* =========================================================
   RECIPE DEFINITIONS (MATCH MASTER RECIPE BOOK)
   =========================================================
   Ingredient types supported:
   - { type:"percent_vv", percent:0.14, densityKgPerL:1.613 }  // HFCS 42 example
   - { type:"liquid", amount:232, unit:"mL" }                  // flavor/extract liquids
   - { type:"solid",  amount:27,  unit:"g"  }                  // acids, powders
   - { type:"mass",   amount:8.45, unit:"kg" }                 // if you ever want mass-only items
*/

const RECIPES = {
  margarita: {
    name: "Margarita Moonshine",
    base: { gallons: 4, proof: 164 },     // canonical recipe book line
    final: { proof: 60 },
    ingredients: [
      // Sweetness rule: 14% v/v using HFCS 42
      { name: "HFCS 42", type: "percent_vv", percent: 0.14, densityKgPerL: 1.613 },

      // Liquids
      { name: "Apex Margarita Flavor", type: "liquid", amount: 232, unit: "mL" },
      { name: "Apex Orange Extract",   type: "liquid", amount: 39,  unit: "mL" },

      // Solids
      { name: "Citric Acid", type: "solid", amount: 27, unit: "g" },
      { name: "Malic Acid",  type: "solid", amount: 8,  unit: "g" }
    ]
  }
};

const recipeSelect = document.getElementById("recipe");
const recipeMeta = document.getElementById("recipeMeta");
const baseGallonsInput = document.getElementById("baseGallons");
const baseProofInput = document.getElementById("baseProof");
const finalProofInput = document.getElementById("finalProof");
const resultsDiv = document.getElementById("results");

/* ---------- Unit helpers ---------- */
const GAL_TO_L = 3.785411784;

function toGallons(amount, unit){
  const u = (unit || "").toLowerCase();
  if (u === "gal" || u === "gallon" || u === "gallons") return amount;
  if (u === "l" || u === "liter" || u === "liters") return amount / GAL_TO_L;
  if (u === "ml") return (amount / 1000) / GAL_TO_L;
  return 0; // solids/mass don't contribute volume here
}

function fmt(n, d=2){ return Number(n).toFixed(d); }

/* ---------- Populate recipes ---------- */
Object.entries(RECIPES).forEach(([key,r])=>{
  const o = document.createElement("option");
  o.value = key;
  o.textContent = r.name;
  recipeSelect.appendChild(o);
});

function loadRecipe(){
  const r = RECIPES[recipeSelect.value];
  baseGallonsInput.value = r.base.gallons;
  baseProofInput.value = r.base.proof;
  finalProofInput.value = r.final.proof;
  recipeMeta.textContent = `${r.base.gallons} gal @ ${r.base.proof} → ${r.final.proof} proof`;
}

function runWizard(){
  const r = RECIPES[recipeSelect.value];
  if (!r) return;

  const baseGallons = Number(baseGallonsInput.value);
  const baseProof   = Number(baseProofInput.value);
  const finalProof  = Number(finalProofInput.value);

  if (!baseGallons || !baseProof || !finalProof){
    resultsDiv.innerHTML = `<div class="muted">Enter valid base gallons and proofs.</div>`;
    return;
  }

  // Final volume + PG from authoritative engine
  let scaledBase;
  try{
    scaledBase = Scaler.scaleFromBase({
      baseGallons,
      baseProof,
      targetProof: finalProof
    });
  } catch(e){
    resultsDiv.innerHTML = `<div class="muted">${e.message}</div>`;
    return;
  }

  // Scale factor for “recipe book amounts”
  const multiplier = baseGallons / r.base.gallons;

  // Compute volume-taking additions (HFCS + other liquids if desired)
  let volumeAdditionsGal = 0;

  // Build ingredient cards
  const ingredientBlocks = (r.ingredients || []).map(ing => {
    const type = ing.type || "mass";

    // HFCS / sweetness rule: percent of FINAL volume
    if (type === "percent_vv"){
      const volGal = scaledBase.finalVolume * ing.percent; // v/v
      volumeAdditionsGal += volGal;

      const volL = volGal * GAL_TO_L;
      const kg = (ing.densityKgPerL ? (volL * ing.densityKgPerL) : null);

      return `
        <div class="result">
          <div class="k">${ing.name}</div>
          <div class="v">${fmt(volGal,3)} gal</div>
          <div class="muted">
            ${fmt(ing.percent*100,1)}% v/v of final
            ${kg !== null ? ` • ≈ ${fmt(kg,2)} kg` : ""}
          </div>
        </div>
      `;
    }

    // Liquids: scale by multiplier, contribute (optionally) to volume
    if (type === "liquid"){
      const scaledAmt = (ing.amount || 0) * multiplier;
      const volGal = toGallons(scaledAmt, ing.unit || "mL");
      // If you want to subtract flavor/extract volume from water too, keep next line:
      volumeAdditionsGal += volGal;

      return `
        <div class="result">
          <div class="k">${ing.name}</div>
          <div class="v">${fmt(scaledAmt, ing.unit==="mL" ? 0 : 3)} ${ing.unit}</div>
          <div class="muted">× ${fmt(multiplier,4)}</div>
        </div>
      `;
    }

    // Solids: scale by multiplier, no volume effect
    if (type === "solid"){
      const scaledAmt = (ing.amount || 0) * multiplier;
      return `
        <div class="result">
          <div class="k">${ing.name}</div>
          <div class="v">${fmt(scaledAmt,3)} ${ing.unit}</div>
          <div class="muted">× ${fmt(multiplier,4)}</div>
        </div>
      `;
    }

    // Mass-only fallback
    const scaledAmt = (ing.amount || 0) * multiplier;
    return `
      <div class="result">
        <div class="k">${ing.name}</div>
        <div class="v">${fmt(scaledAmt,3)} ${ing.unit || ""}</div>
        <div class="muted">× ${fmt(multiplier,4)}</div>
      </div>
    `;
  }).join("");

  // ✅ Correct water: subtract HFCS + other liquid volumes from water
  const correctedWaterGal = scaledBase.finalVolume - baseGallons - volumeAdditionsGal;

  resultsDiv.innerHTML = `
    <div class="result">
      <div class="k">Water Required</div>
      <div class="v">${fmt(correctedWaterGal,3)} gal</div>
      <div class="muted">Final − Base − Liquid Adds</div>
    </div>

    <div class="result">
      <div class="k">Final Volume</div>
      <div class="v">${fmt(scaledBase.finalVolume,3)} gal</div>
    </div>

    <div class="result">
      <div class="k">Alcohol Content</div>
      <div class="v">${fmt(scaledBase.alcoholPG,2)} PG</div>
    </div>

    ${ingredientBlocks}
  `;
}

recipeSelect.addEventListener("change",()=>{loadRecipe();runWizard();});
[baseGallonsInput, baseProofInput, finalProofInput].forEach(el=>{
  el.addEventListener("input", runWizard);
});

loadRecipe();
runWizard();
</script>
</body>
</html>
