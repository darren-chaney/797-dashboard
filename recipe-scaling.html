<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Recipe Scaling</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared Header CSS -->
  <link rel="stylesheet" href="header.css" />

  <!-- Core Engines -->
  <script src="scaler.js"></script>
  <script src="recipes.js"></script>

  <style>
    body{
      margin:0;
      background:#0f172a;
      color:#e5e7eb;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    main{
      max-width:1000px;
      margin:0 auto;
      padding:32px 20px;
    }
    h1{font-size:1.7rem;margin:0 0 6px}
    .subtitle{color:#9ca3af;margin-bottom:22px}

    .panel{
      background:#111c33;
      border:1px solid #334155;
      border-radius:12px;
      padding:20px;
      margin-bottom:18px;
    }
    .panel h2{font-size:1.05rem;margin:0 0 14px}

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(160px, max-content));
      gap:20px;
      align-items:end;
    }

    .grid > div{display:flex;flex-direction:column}

    input[type="number"]{text-align:right}

    label{
      font-size:.85rem;
      color:#cbd5e1;
      margin-bottom:6px;
    }

    select,input{
      padding:10px;
      border-radius:8px;
      border:1px solid #334155;
      background:#0f172a;
      color:#e5e7eb;
      font-size:.95rem;
    }
    select{
    appearance:none;
    -webkit-appearance:none;
    background-image:
    linear-gradient(45deg, transparent 50%, #9ca3af 50%),
    linear-gradient(135deg, #9ca3af 50%, transparent 50%);
    background-position:
    calc(100% - 18px) 55%,
    calc(100% - 12px) 55%;
    background-size:6px 6px, 6px 6px;
    background-repeat:no-repeat;
    padding-right:36px;
    cursor:pointer;
    }

    .results{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(210px,1fr));
      gap:14px;
      margin-top:10px;
    }

    .result{
      background:#0b1220;
      border:1px solid #334155;
      border-radius:12px;
      padding:16px;
    }

    .k{
      font-size:.85rem;
      color:#cbd5e1;
      letter-spacing:.02em;
      margin-bottom:6px;
    }

    .v{font-size:1.2rem;font-weight:700}
    .muted{color:#9ca3af;font-size:.85rem}

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #475569;
      background:#0f172a;
      font-size:.78rem;
      margin-top:8px;
    }

    .results-version{
      margin-top:12px;
      font-size:.72rem;
      color:#9ca3af;
      opacity:.7;
      text-align:right;
    }
  </style>
</head>

<body>

<div id="global-header"></div>

<script>
  const APP_VERSION = "v1.6.1";

  fetch("header.html",{cache:"no-store"})
    .then(r=>r.text())
    .then(html=>{
      document.getElementById("global-header").innerHTML = html;
      if (typeof setActiveModule === "function") {
        setActiveModule("products");
      }
    });
</script>

<main>
  <h1>Recipe Scaling</h1>
  <div class="subtitle">Scale approved recipes from base spirit usage</div>

  <!-- STEP 1 -->
  <section class="panel">
    <h2>Step 1 — Select Recipe</h2>
    <select id="recipe"></select>
    <div class="pill" id="recipeMeta">—</div>
    <div id="recipeSummary" class="results"></div>
  </section>

  <!-- STEP 2 -->
  <section class="panel">
    <h2>Step 2 — Base Spirit Used</h2>
    <div class="grid">
      <div>
        <label>Gallons of Base Spirit</label>
        <input id="baseGallons" type="number" step="0.01">
      </div>
      <div>
        <label>Base Proof</label>
        <input id="baseProof" type="number">
      </div>
      <div>
        <label>Final Proof</label>
        <input id="finalProof" type="number">
      </div>
      <div>
        <label>Sweetness % (HFCS v/v)</label>
        <input id="sweetPercent" type="number" step="0.1" disabled>
        <label class="muted" style="margin-top:6px">
          <input id="sweetOverride" type="checkbox">
          Override recipe sweetness
        </label>
      </div>
    </div>
  </section>

  <!-- RESULTS -->
  <section class="panel">
    <h2>Results</h2>
    <div id="results" class="results"></div>
    <div class="results-version">
      Recipe Scaling • <span id="app-version"></span>
    </div>
  </section>
</main>

<script>
/* =========================
   SAFETY CHECK
   ========================= */
if (!window.RECIPES) {
  throw new Error("RECIPES not loaded. Check recipes.js path.");
}

/* =========================
   UTILITIES
   ========================= */
const GAL_TO_L = 3.785411784;
const fmt = (n,d=3)=>Number(n).toFixed(d);
const fmt1 = n=>Number(n).toFixed(1);

document.getElementById("app-version").textContent = APP_VERSION;

/* =========================
   DOM
   ========================= */
const recipeSelect = document.getElementById("recipe");
const recipeMeta = document.getElementById("recipeMeta");
const recipeSummary = document.getElementById("recipeSummary");

const baseGallonsInput = document.getElementById("baseGallons");
const baseProofInput   = document.getElementById("baseProof");
const finalProofInput  = document.getElementById("finalProof");

const sweetPercentInput = document.getElementById("sweetPercent");
const sweetOverrideInput = document.getElementById("sweetOverride");

const resultsDiv = document.getElementById("results");

/* =========================
   INIT DROPDOWN
   ========================= */
Object.entries(RECIPES).forEach(([key,r])=>{
  const o = document.createElement("option");
  o.value = key;
  o.textContent = r.name;
  recipeSelect.appendChild(o);
});

function getHFCS(r){
  const hfcs = r.ingredients.find(i=>i.type==="percent_vv");
  if (!hfcs) throw new Error(`Recipe "${r.name}" missing HFCS percent.`);
  return hfcs;
}

function renderSummary(r,pct01){
  recipeSummary.innerHTML = `
    <div class="result">
      <div class="k">Canonical Base</div>
      <div class="v">${r.base.gallons} gal @ ${r.base.proof}</div>
    </div>
    <div class="result">
      <div class="k">Final Proof</div>
      <div class="v">${r.final.proof}</div>
    </div>
    <div class="result">
      <div class="k">Sweetness</div>
      <div class="v">${fmt1(pct01*100)}% HFCS-42</div>
    </div>
  `;
}

function loadRecipe(){
  const r = RECIPES[recipeSelect.value];
  const hfcs = getHFCS(r);

  baseGallonsInput.value = r.base.gallons;
  baseProofInput.value   = r.base.proof;
  finalProofInput.value  = r.final.proof;

  sweetPercentInput.value = fmt1(hfcs.percent*100);
  sweetPercentInput.disabled = true;
  sweetOverrideInput.checked = false;

  recipeMeta.textContent =
    `${r.base.gallons} gal @ ${r.base.proof} → ${r.final.proof} proof`;

  renderSummary(r,hfcs.percent);
}

function runWizard(){
  const r = RECIPES[recipeSelect.value];
  const hfcs = getHFCS(r);

  const baseGallons = +baseGallonsInput.value;
  const baseProof   = +baseProofInput.value;
  const finalProof  = +finalProofInput.value;

  const pct01 = sweetOverrideInput.checked
    ? (+sweetPercentInput.value/100 || hfcs.percent)
    : hfcs.percent;

  const scaled = Scaler.scaleFromBase({
    baseGallons,
    baseProof,
    targetProof: finalProof
  });

  const hfcsGal = scaled.finalVolume * pct01;
  const hfcsKg  = hfcsGal * GAL_TO_L * hfcs.densityKgPerL;
  const waterGal = scaled.finalVolume - baseGallons - hfcsGal;

  const multiplier = baseGallons / r.base.gallons;

  const ingredientBlocks = r.ingredients
    .filter(i=>i.type!=="percent_vv")
    .map(i=>{
      const amt = i.amount * multiplier;
      return `
        <div class="result">
          <div class="k">${i.name}</div>
          <div class="v">${fmt(amt)} ${i.unit}</div>
        </div>`;
    }).join("");

  resultsDiv.innerHTML = `
    <div class="result"><div class="k">Water Required</div><div class="v">${fmt(waterGal)} gal</div></div>
    <div class="result"><div class="k">Final Volume</div><div class="v">${fmt(scaled.finalVolume)} gal</div></div>
    <div class="result"><div class="k">Alcohol Content</div><div class="v">${fmt(scaled.alcoholPG,2)} PG</div></div>
    <div class="result"><div class="k">HFCS-42</div><div class="v">${fmt(hfcsKg,2)} kg</div><div class="muted">${fmt1(pct01*100)}% v/v</div></div>
    ${ingredientBlocks}
  `;

  renderSummary(r,pct01);
}

/* =========================
   EVENTS
   ========================= */
sweetOverrideInput.addEventListener("change",()=>{
  sweetPercentInput.disabled = !sweetOverrideInput.checked;
  runWizard();
});

recipeSelect.addEventListener("change",()=>{
  loadRecipe();
  runWizard();
});

[baseGallonsInput, baseProofInput, finalProofInput, sweetPercentInput]
  .forEach(el=>el.addEventListener("input",runWizard));

/* =========================
   START
   ========================= */
loadRecipe();
runWizard();
</script>

</body>
</html>
