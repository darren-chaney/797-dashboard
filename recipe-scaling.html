<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Recipe Scaling</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared Header CSS -->
  <link rel="stylesheet" href="header.css" />

  <!-- Scaling Engine -->
  <script src="scaler.js"></script>

  <style>
    body{
      margin:0;
      background:#0f172a;
      color:#e5e7eb;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    main{
      max-width:1000px;
      margin:0 auto;
      padding:32px 20px;
    }
    h1{font-size:1.7rem;margin:0 0 6px}
    .subtitle{color:#9ca3af;margin-bottom:22px}

    .panel{
      background:#111c33;
      border:1px solid #334155;
      border-radius:12px;
      padding:20px;
      margin-bottom:18px;
    }
    .panel h2{font-size:1.05rem;margin:0 0 14px}

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(160px, max-content));
      gap:20px;
      align-items:end;
    }
    
    input[type="number"]{
      text-align:right;
    }

    .grid input{
      width:160px;
      max-width:100%;
    }
    
    .grid > div{
      display:flex;
      flex-direction:column;
    }

    .panel input{
    max-width:100%;
    }

    label{
      display:block;
      font-size:.85rem;
      color:#cbd5e1;
      margin-bottom:6px;
    }

    select,input{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid #334155;
      background:#0f172a;
      color:#e5e7eb;
      font-size:.95rem;
    }

    .results{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(210px,1fr));
      gap:14px;
      margin-top:10px;
    }

    .result{
      background:#0b1220;           /* darker than page */
      border:1px solid #334155;
      border-radius:12px;
      padding:16px;
      box-shadow:
      inset 0 0 0 1px rgba(255,255,255,0.02);
    }
    .result .v{
      font-size:1.2rem;
      font-weight:700;
      letter-spacing:.2px;
    }
    .panel + .panel{
      margin-top:22px;
    }
    .k{font-size:.75rem;color:#9ca3af;margin-bottom:4px}
    .v{font-size:1.15rem;font-weight:650}
    .muted{color:#9ca3af;font-size:.85rem}

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #475569;
      background:#0f172a;
      font-size:.78rem;
      margin-top:8px;
    }

   .results-version{
      margin-top:12px;
      font-size:.72rem;
      color:#9ca3af;
      opacity:.7;
      text-align:right;
    }

  </style>
</head>

<body>

<div id="global-header"></div>

<script>
  /* =========================
     PAGE CONFIG
     ========================= */
  const APP_VERSION = "v1.2.0";

  const PAGE_TITLE = "Recipe Scaling";
  const PAGE_SUBTITLE = "Wizard scaling from approved base recipes.";

  fetch("header.html",{cache:"no-store"})
    .then(r=>r.text())
    .then(html=>{
      document.getElementById("global-header").innerHTML=html;
      document.getElementById("page-title").textContent=PAGE_TITLE;
      document.getElementById("page-subheading").textContent=PAGE_SUBTITLE;
      setActiveModule("products");
    });
</script>

<main>
  <h1>Recipe Scaling</h1>
  <div class="subtitle">Scale approved recipes from base spirit usage</div>

  <!-- STEP 1 -->
  <section class="panel">
    <h2>Step 1 — Select Recipe</h2>
    <select id="recipe"></select>
    <div class="pill" id="recipeMeta">—</div>
  </section>

  <!-- STEP 2 -->
  <section class="panel">
    <h2>Step 2 — Base Spirit Used</h2>
    <div class="grid">
      <div>
        <label>Gallons of Base Spirit</label>
        <input id="baseGallons" type="number" step="0.01">
      </div>
      <div>
        <label>Base Proof</label>
        <input id="baseProof" type="number">
      </div>
      <div>
        <label>Final Proof</label>
        <input id="finalProof" type="number">
      </div>
    </div>
  </section>

  <!-- RESULTS -->
<section class="panel">
  <h2>Results</h2>
  <div id="results" class="results"></div>

  <!-- VERSION -->
  <div class="results-version">
    Recipe Scaling • <span id="app-version"></span>
  </div>
</section>
</main>


<script>
/* =========================================================
   RECIPE DEFINITIONS (MATCH MASTER RECIPE BOOK)
   ========================================================= */

const RECIPES = {
  margarita: {
    name: "Margarita Moonshine",
    base: { gallons: 4, proof: 164 },
    final: { proof: 60 },
    ingredients: [
      { name:"HFCS 42", type:"percent_vv", percent:0.14, densityKgPerL:1.613 },
      { name:"Apex Margarita Flavor", type:"liquid", amount:232, unit:"mL" },
      { name:"Apex Orange Extract",   type:"liquid", amount:39,  unit:"mL" },
      { name:"Citric Acid", type:"solid", amount:27, unit:"g" },
      { name:"Malic Acid",  type:"solid", amount:8,  unit:"g" }
    ]
  }
  spicy_pineapple: {
  name: "Spicy Pineapple Moonshine",
  base: { gallons: 5, proof: 155 },
  final: { proof: 60 },
  ingredients: [
    {
      name: "HFCS 42",
      type: "percent_vv",
      percent: 0.14,
      densityKgPerL: 1.613
    },
    {
      name: "Apex Pineapple Flavor (Natural & Artificial)",
      type: "liquid",
      amount: 420,
      unit: "mL"
    },
    {
      name: "Apex Capsicum Natural Extract",
      type: "liquid",
      amount: 12,
      unit: "mL"
    },
    {
      name: "Citric Acid",
      type: "solid",
      amount: 27,
      unit: "g"
    },
    {
      name: "Malic Acid",
      type: "solid",
      amount: 8,
      unit: "g"
    }
  ]
}

};

const GAL_TO_L = 3.785411784;
function fmt(n,d=3){ return Number(n).toFixed(d); }

document.getElementById("app-version").textContent = APP_VERSION;

const recipeSelect = document.getElementById("recipe");
const recipeMeta = document.getElementById("recipeMeta");
const baseGallonsInput = document.getElementById("baseGallons");
const baseProofInput = document.getElementById("baseProof");
const finalProofInput = document.getElementById("finalProof");
const resultsDiv = document.getElementById("results");

Object.entries(RECIPES).forEach(([key,r])=>{
  const o=document.createElement("option");
  o.value=key;
  o.textContent=r.name;
  recipeSelect.appendChild(o);
});

function loadRecipe(){
  const r=RECIPES[recipeSelect.value];
  baseGallonsInput.value=r.base.gallons;
  baseProofInput.value=r.base.proof;
  finalProofInput.value=r.final.proof;
  recipeMeta.textContent =
    `${r.base.gallons} gal @ ${r.base.proof} → ${r.final.proof} proof`;
}

function runWizard(){
  const r=RECIPES[recipeSelect.value];
  const baseGallons=Number(baseGallonsInput.value);
  const baseProof=Number(baseProofInput.value);
  const finalProof=Number(finalProofInput.value);

  if(!baseGallons||!baseProof||!finalProof){
    resultsDiv.innerHTML=`<div class="muted">Enter valid inputs.</div>`;
    return;
  }

  const scaled=Scaler.scaleFromBase({
    baseGallons,
    baseProof,
    targetProof:finalProof
  });

  const multiplier = baseGallons / r.base.gallons;
  let hfcsVolumeGal = 0;

  const ingredientBlocks = r.ingredients.map(i=>{
    if(i.type==="percent_vv"){
      hfcsVolumeGal = scaled.finalVolume * i.percent;
      const kg = hfcsVolumeGal * GAL_TO_L * i.densityKgPerL;

      return `
        <div class="result">
        <div class="k">${i.name}</div>
        <div class="v">${fmt(kg,2)} kg</div>
        <div class="muted">
          (≈ ${fmt(hfcsVolumeGal)} gal • ${fmt(i.percent*100,1)}% v/v)
        </div>
        </div>
  `    ;
    }

    if(i.type==="liquid"){
      const amt = i.amount * multiplier;
      return `
        <div class="result">
          <div class="k">${i.name}</div>
          <div class="v">${fmt(amt,0)} ${i.unit}</div>
          <div class="muted">× ${fmt(multiplier,4)}</div>
        </div>
      `;
    }
    if(i.type==="solid"){
      const amt = i.amount * multiplier;
      return `
        <div class="result">
          <div class="k">${i.name}</div>
          <div class="v">${fmt(amt)} ${i.unit}</div>
          <div class="muted">× ${fmt(multiplier,4)}</div>
        </div>
      `;
    }
  }).join("");

  const waterGal =
    scaled.finalVolume - baseGallons - hfcsVolumeGal;

  resultsDiv.innerHTML = `
    <div class="result">
      <div class="k">Water Required</div>
      <div class="v">${fmt(waterGal)} gal</div>
    </div>
    <div class="result">
      <div class="k">Final Volume</div>
      <div class="v">${fmt(scaled.finalVolume)} gal</div>
    </div>
    <div class="result">
      <div class="k">Alcohol Content</div>
      <div class="v">${fmt(scaled.alcoholPG,2)} PG</div>
    </div>
    ${ingredientBlocks}
  `;
}

recipeSelect.addEventListener("change",()=>{loadRecipe();runWizard();});
[baseGallonsInput,baseProofInput,finalProofInput]
  .forEach(el=>el.addEventListener("input",runWizard));

loadRecipe();
runWizard();
</script>

</body>
</html>
